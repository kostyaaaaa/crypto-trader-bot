# `analyze-candles` — модуль трендового аналізу (EMA + RSI)

> **Призначення:** дати простий, надійний і зрозумілий сигнал `LONG` / `SHORT` / `NEUTRAL` на основі тренду (EMA) та імпульсу (RSI).  
> **Використання:** модуль повертає компактний об’єкт із сигналом, силою сигналу та корисною мета-інформацією для логування й дебагу.

---

## 1) Що робить модуль

Модуль обчислює:

- **EMA(9)** і **EMA(21)** за масивом цін закриття (close),
- **RSI(14)** за тим самим масивом,
- далі формує дві оцінки **`longScore`** і **`shortScore`** (0–100),
- на їхній основі визначає підсумковий **`signal`**: `LONG`, `SHORT` або `NEUTRAL`,
- повертає **`strength`** — максимальне з двох значень (`longScore` або `shortScore`),
- додає **`meta`**: значення EMA, RSI та розрив між EMA у процентах.

> Якщо свічок менше ніж **21**, модуль повертає `null` і виводить у лог повідомлення, що даних недостатньо.

---

## 2) Як це впливає на оцінку/рішення бота

- **EMA(9) vs EMA(21)** дають базове уявлення про напрямок тренду:
  - коли **EMA(9) > EMA(21)**, тренд радше висхідний → модуль підвищує `longScore`;
  - коли **EMA(9) < EMA(21)**, тренд радше низхідний → модуль підвищує `shortScore`.
- **RSI(14)** додає імпульсний (momentum) контекст:
  - **RSI < 30** (перепроданість) підсилює лонговий сценарій;
  - **RSI > 70** (перекупленість) підсилює шортовий сценарій.

На виході стратегія може:

- **фільтрувати входи** (наприклад, не шортити проти сильного ап-тренду),
- **модулювати розмір/дозвіл угоди** (наприклад, торгувати тільки якщо `strength ≥ 60`).

---

## 3) Чому це важливо

1. **Комбінація тренд + імпульс** дає стійкіший сигнал: подвійна підтверджувальна логіка знижує кількість випадкових входів у шумі.
2. **Простота й інтерпретованість**: EMA та RSI — класика теханалізу, легко читаються й пояснюються (важливо для логування та дебагу).
3. **Шкала сили сигналу (0–100)** дозволяє плавно керувати ризиком, а не працювати з «чорно-білими» умовами.

---

## 4) Покроково: як працює код

1. **Перевірка вхідних даних**

   ```js
   if (!candles || candles.length < 21) return null;
   ```

   Потрібно щонайменше 21 свічка, щоб коректно порахувати EMA(21) та RSI(14).

2. **Підготовка рядів даних**

   ```js
   const closes = candles.map((c) => c.close);
   ```

   Беремо масив цін закриття — він є базою для EMA та RSI.

3. **Обчислення EMA**

   ```js
   const emaFast = EMA(closes, 9);
   const emaSlow = EMA(closes, 21);
   const emaGapPct = ((emaFast - emaSlow) / emaSlow) * 100;
   ```

   - `emaFast` = EMA(9), `emaSlow` = EMA(21).
   - `emaGapPct` — **процентний розрив** між швидкою та повільною EMA. Позитивне значення → ап-тренд; негативне → даун-тренд.

4. **Обчислення RSI**

   ```js
   const rsi = RSI(closes, 14);
   ```

   Значення від 0 до 100. Типові зони: `<30` — перепроданість, `>70` — перекупленість.

5. **Початкові бали сили**

   ```js
   let longScore = 50;
   let shortScore = 50;
   ```

   Стартуємо з нейтральної точки 50/50.

6. **Вплив EMA-розриву**

   ```js
   if (emaGapPct > 0) {
     longScore += Math.min(30, Math.abs(emaGapPct) * 5);
     shortScore -= Math.min(30, Math.abs(emaGapPct) * 5);
   } else {
     shortScore += Math.min(30, Math.abs(emaGapPct) * 5);
     longScore -= Math.min(30, Math.abs(emaGapPct) * 5);
   }
   ```

   - Чим більший за модулем розрив EMA, тим сильніший трендовий сигнал.
   - Коефіцієнт підсилення — `* 5`, але **обмежений «стелею» у 30 пунктів**.

7. **Вплив RSI-зон**

   ```js
   if (rsi < 30) {
     longScore += 20;
     shortScore -= 20;
   } else if (rsi > 70) {
     shortScore += 20;
     longScore -= 20;
   }
   ```

   - Зони перепроданості/перекупленості додають **фіксовані ±20 пунктів**.
   - В середині діапазону 30–70 RSI не впливає на бали.

8. **Обмеження діапазону 0–100**

   ```js
   longScore = Math.max(0, Math.min(100, longScore));
   shortScore = Math.max(0, Math.min(100, shortScore));
   ```

   Це захищає від виходу за межі шкали.

9. **Фінальний сигнал**

   ```js
   let signal = 'NEUTRAL';
   if (longScore > shortScore) signal = 'LONG';
   else if (shortScore > longScore) signal = 'SHORT';
   ```

   Переможець між `longScore` і `shortScore` визначає напрямок.

10. **Повернений об’єкт**

    ```js
    return {
      module: 'trend',
      symbol,
      signal, // LONG | SHORT | NEUTRAL
      strength: Math.max(longScore, shortScore),
      meta: {
        LONG: longScore,
        SHORT: shortScore,
        emaFast: parseFloat(emaFast.toFixed(2)),
        emaSlow: parseFloat(emaSlow.toFixed(2)),
        emaGapPct: parseFloat(emaGapPct.toFixed(2)),
        rsi: parseFloat(rsi.toFixed(2)),
      },
    };
    ```

    - `module` — ідентифікатор (щоб інші частини системи знали джерело сигналу).
    - `strength` — «наскільки ми впевнені» у поточному напрямку.
    - `meta` — числа, корисні для логів/дашборду.

---

## 5) Вхідні та вихідні дані

### Вхід

```ts
symbol?: string        // тикер, напр. 'ETHUSDT' (не обов’язковий)
candles: Array<{       // обов’язково ≥ 21 елемент
  close: number        // ціна закриття свічки
  // інші поля (open, high, low, time...) не використовуються цим модулем
}>
```

### Вихід

```ts
null |
  {
    module: 'trend',
    symbol: string,
    signal: 'LONG' | 'SHORT' | 'NEUTRAL',
    strength: number, // 0..100
    meta: {
      LONG: number,
      SHORT: number,
      emaFast: number,
      emaSlow: number,
      emaGapPct: number,
      rsi: number,
    },
  };
```

---

## 6) Приклад поверненого значення

```json
{
  "module": "trend",
  "symbol": "ETHUSDT",
  "signal": "LONG",
  "strength": 74,
  "meta": {
    "LONG": 74,
    "SHORT": 26,
    "emaFast": 3567.12,
    "emaSlow": 3521.4,
    "emaGapPct": 1.3,
    "rsi": 55.42
  }
}
```

> **Пояснення:** EMA(9) суттєво вище EMA(21) (+1.30%), RSI у «здоровій» зоні 30–70. Тому перевага за LONG і сила 74.

---

## 7) Налаштування й тюнінг

- **Вікна EMA/RSI:** `EMA(9/21)` і `RSI(14)` — усталений, збалансований вибір. Зменшення періодів → більше чутливості (і шуму), збільшення → плавніший сигнал (але повільніший).
- **Ваги/стелі:**
  - множник для EMA-розриву: `* 5`, **стеля 30**;
  - поправка від RSI: **±20** в крайніх зонах.
    За потреби можна ослабити/підсилити, але важливо **не допустити** ситуації, коли один фактор повністю «затирає» інший.
- **Пороги RSI:** класика 30/70 підходить більшості інструментів; для дуже волатильних можна розширити до 25/75.

---

## 8) Типові крайні випадки та поради

- **Мало свічок (`<21`)** → повертається `null`. Варто обробляти це у викликачі (пропустити сигнал або дочекатися достатньої історії).
- **Дані з пропусками/артефактами**: переконайтесь, що `close` — число без `NaN` і `null`.
- **Нуль/надмалі значення EMA(21)**: в реальному ринку ціна ≠ 0, але якщо дані тестові/помилкові — можливе ділення на дуже мале число. Перевіряйте джерела котирувань.
- **Різні таймфрейми**: модуль нейтральний до ТФ, але **всі свічки мають бути одного ТФ**. Від ТФ залежить чутливість сигналу.

---

## 9) Де й як використовувати у боті

- Як **фільтр напрямку**: дозволяти лонг-сетапи лише коли `signal === 'LONG'` і `strength ≥ X`.
- Як **модифікатор розміру позиції**: наприклад, масштабувати ризик/розмір залежно від `strength`.
- Як **частину ансамблю** разом з модулями волатильності, тренд-режиму, об’єму тощо — потім агрегувати їхні бали у загальний індикатор якості входу.

---

## 10) Короткий TL;DR для нетехнічних

- Беремо ціни закриття свічок, рахуємо два ковзні середні (швидке на 9 свічок і повільне на 21) — це показує, куди йде тренд.
- Рахуємо RSI (14) — показує, чи ринок «перекуплений» або «перепроданий».
- Складаємо бали для «лонгу» і «шорту»: тренд + імпульс.
- Вибираємо, який бік сильніший, і повертаємо `LONG`/`SHORT`/`NEUTRAL` з силою 0–100.
- Цей сигнал простий, логічний і добре підходить як фільтр для входів.
