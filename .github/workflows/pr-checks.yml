name: PR Quality Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Check all projects in parallel
      - name: Install all dependencies
        run: |
          echo "Installing dependencies for all projects..."
          cd server && npm ci && cd ..
          cd crypto-trader-console && npm ci && cd ..
          cd trader-bot && npm ci && cd ..
          echo "âœ… All dependencies installed"

      - name: Run comprehensive checks
        run: |
          echo "ğŸ” Running comprehensive code quality checks..."

          # Server checks
          echo "ğŸ“ Checking Server project..."
          cd server
          echo "  - Syntax check..."
          find src -name "*.js" -exec node --check {} \;
          echo "  âœ… Server syntax OK"
          cd ..

          # Console checks  
          echo "ğŸ“ Checking Console project..."
          cd crypto-trader-console
          echo "  - TypeScript compilation..."
          npx tsc -b --noEmit
          echo "  - ESLint check..."
          npm run lint
          echo "  - Build test..."
          npm run build
          echo "  âœ… Console build OK"
          cd ..

          # Trader Bot checks
          echo "ğŸ“ Checking Trader Bot project..."
          cd trader-bot
          echo "  - Syntax check..."
          find src -name "*.js" -exec node --check {} \;
          echo "  âœ… Trader Bot syntax OK"
          cd ..

          echo ""
          echo "ğŸ‰ All quality checks passed!"
          echo "âœ… Code is ready for review and merge"

      - name: Comment PR Status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { context } = require('@actions/core');
            const jobStatus = '${{ job.status }}';

            let message;
            if (jobStatus === 'success') {
              message = `## âœ… Code Quality Check Passed!
              
              All projects have been successfully validated:
              
              - **Server**: JavaScript syntax âœ…
              - **Console**: TypeScript compilation, linting, and build âœ…  
              - **Trader Bot**: JavaScript syntax âœ…
              
              ğŸš€ This PR is ready for review and merge!`;
            } else {
              message = `## âŒ Code Quality Check Failed
              
              Some issues were found that need to be fixed before merging.
              Please check the workflow logs for details.
              
              ğŸ”§ Fix the issues and push your changes to trigger a new check.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
